# マルチタスク分類Webアプリケーション

このウェブアプリケーションは、機械学習を利用して、テキストデータと画像データの分類を行うためのRESTful APIとインターフェースを提供します。アプリケーションは、複数の分類タスクを統合的に管理し、効率的に提供することを目的としています。

![Architecture](image/webapp.png)
![Streamlit](image/streamlit_app.png)

## 目次
1. [使用するモデルとその目的](#使用するモデルとその目的)
2. [マルチタスクAPIの構造](#マルチタスクAPIの構造)
3. [アーキテクチャ](#アーキテクチャ)
4. [データ検証とAPIテスト](#データ検証とAPIテスト)
5. [デプロイメント](#デプロイメント)
6. [使用ツール](#使用ツール)

## 使用するモデルとその目的

### 感情分類モデル
- **目的**: 映画レビューをポジティブまたはネガティブに分類する。

### 災害ツイート分類モデル
- **目的**: ツイートが災害に関連しているかどうかを判断する。

### 人間のポーズ分類モデル
- **目的**: 画像データから人間の行動（例：立っている、座っているなど）を分類する。

これらのモデルはBERTとその軽量版であるTiny BERTを使用して実装されています。Tiny BERTはリソース消費を最小限に抑えつつ高精度を維持するように最適化されています。モデルはHuggingFaceツールを使用してトレーニングされ、Amazon S3に保存されています。サーバーはS3からモデルをダウンロードし、FastAPIフレームワークを通じてユーザーに提供します。

## マルチタスクAPIの構造

このウェブアプリケーションは、複数のモデルを単一のAPIに統合し、ユーザーが単一のインターフェースを通じて様々な分類タスクを実行できるようにしています。たとえば、ユーザーは特定のエンドポイントにリクエストを送信して、センチメント分類、災害ツイート分類、人間のポーズ分類を行うことができます。

## アーキテクチャ

- **FastAPIとUvicornサーバー**: アプリケーションはFastAPIフレームワークを使用して構築されており、これは高速で軽量なPython用のウェブフレームワークです。FastAPIはUvicornサーバーと組み合わせて使用され、高性能なAPIを提供します。

- **MLモデル統合**: FastAPIがリクエストを受け取ると、適切な機械学習モデルに入力データを渡して分類結果を生成します。結果はユーザーに返され、特定のタスクに合わせて調整されます。

- **ユーザーインターフェース**: Streamlitを使用して簡単なウェブインターフェースを作成し、ユーザーがAPIと簡単に対話できるようにしています。ユーザーはセンチメント分類、災害ツイート分類、人間のポーズ分類を簡単に実行できます。

## データ検証とAPIテスト

- **Pydanticによるデータ検証**: FastAPIはPydanticを使用してデータモデルを定義し、APIに送信されるデータの整合性を検証します。これにより、正確なデータのみがシステムに入ることが保証されます。

- **APIテスト**: POSTMANなどのツールを使用してAPIをテストし、期待通りに動作することを確認します。

## デプロイメント

- **AWS EC2へのデプロイメント**: モデルとAPIはAWS EC2サーバーにデプロイされ、これにより本番環境でアクセスできるようになります。これにより、インターネット経由でAPIにアクセスし、様々なタスクにモデルを活用することができます。

## 使用ツール

- **FastAPI**: Python 3.8+でAPIを構築するための現代的で高速なウェブフレームワーク。
- **Uvicorn**: FastAPIアプリケーションを提供するための超高速ASGIサーバー。
- **Streamlit**: Pythonでインタラクティブなウェブアプリケーションを作成するためのフレームワーク。
- **HuggingFace Transformers**: BERTやTiny BERTなどの最先端NLPモデルのためのライブラリ。
- **Pydantic**: Pythonの型アノテーションを使用したデータ検証と設定管理。
- **POSTMAN**: APIのテストに人気のあるツール。
- **AWS S3**: モデルを保存および取得するためのAmazonのクラウドストレージサービス。
- **AWS EC2**: アプリケーションをデプロイするためのAmazonのクラウドコンピューティングサービス。
- **Docker** (オプション): アプリケーションと依存関係をパッケージ化するためのコンテナ化ツール。

## メモ
  1. 効率性の追求
署名付きURLを利用した画像予測の最適化:
画像ファイルを直接APIに送信するのではなく、S3にアップロードし、その署名付きURLをAPIに渡すという方法が採用されています。これにより、ネットワーク帯域の使用が抑えられ、API処理がより迅速に行われます。画像の送信が効率的になり、全体的なシステムのパフォーマンスが向上します。
デバイスの動的選択:
GPUが利用可能な場合はGPUを、自動的に選択することで、モデルの推論速度を最大化しています。これにより、計算資源の利用が最適化され、予測処理が高速化されます。
2. コードの再利用性とモジュール化
データモデルの設計 (NLPDataInput, ImageDataInput, NLPDataOutput, ImageDataOutput):
Pydanticを使って入力と出力のデータモデルを定義することで、コードの再利用性が高まり、データの一貫性とバリデーションが容易になっています。異なるAPIエンドポイントで同じデータ構造を使用できるため、コードのメンテナンスが容易です。
S3関連のユーティリティ関数 (download_dir, upload_image_to_s3):
S3に対する操作を関数化し、再利用可能な形で提供しています。これにより、コードのDRY原則（Don't Repeat Yourself）を守り、必要に応じて機能を簡単に拡張または変更できるようにしています。
3. アクセス制御
バリデーションの強化:
Pydanticを使用して、入力データ（例えばEメールアドレスやURL）が有効な形式であるかを事前にチェックしています。これにより、無効なデータがAPIに渡されるのを防ぎ、システム全体の信頼性が向上しています。
4. パフォーマンス最適化
予測時間の計測と出力:
APIの各エンドポイントで、モデルの推論にかかった時間を計測し、ユーザーに返す設計がなされています。これにより、パフォーマンスのモニタリングが容易になり、ユーザーは処理速度を把握できるため、サービスの品質向上に貢献します。
効率的なファイル操作:
os.makedirsやos.pathを使用して、ディレクトリやファイルの操作を効率的に行っています。これにより、ファイル操作に関するエラーを最小限に抑え、スムーズなファイル処理が実現されています。
5. 可読性とメンテナンス性の向上
シンプルで一貫したAPI設計:
APIエンドポイントがそれぞれの機能に応じてシンプルかつ一貫した設計になっており、拡張が容易です。新しい機能やモデルを追加する際にも、コードの変更が容易で、APIのスケーラビリティが高まっています。
